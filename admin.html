<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>æœºå™¨ç‹— - ç®¡ç†ç³»ç»Ÿ</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
/*========== åŸºç¡€ ==========*/
*{box-sizing:border-box;margin:0;padding:0}
body{display:flex;flex-direction:column;min-height:100vh;background:#f7f7f7;font-family:-apple-system,"Helvetica Neue",Arial,sans-serif;padding:20px;}
.header{text-align:center;margin-bottom:20px;padding:15px;background:#fff;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.1)}
.header h1{margin:0;color:#333;font-size:24px}

/*========== æ§åˆ¶é¢æ¿ ==========*/
.control-panel{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-bottom:20px}
.control-btn{padding:12px;background:#fff;border:2px solid #000;border-radius:8px;text-align:center;cursor:pointer;font-weight:bold;transition:all 0.3s}
.control-btn:hover{background:#000;color:#fff;transform:translateY(-2px)}
.control-btn.refresh{background:#1890ff;color:#fff;border-color:#1890ff}
.control-btn.clear{background:#ff4d4f;color:#fff;border-color:#ff4d4f}

/*========== æ•°æ®ç»Ÿè®¡ ==========*/
.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:15px;margin-bottom:20px}
.stat-card{padding:15px;background:#fff;border-radius:8px;text-align:center;box-shadow:0 2px 8px rgba(0,0,0,0.1)}
.stat-card h3{margin:0 0 10px 0;font-size:14px;color:#666}
.stat-card .value{font-size:24px;font-weight:bold;color:#000}

/*========== è¡¨æ ¼æ ·å¼ ==========*/
.table-container{flex:1;overflow:auto;background:#fff;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.1)}
table{width:100%;border-collapse:collapse}
th,td{border:1px solid #e8e8e8;padding:12px 8px;text-align:center;font-size:14px}
th{background:#fafafa;font-weight:bold;position:sticky;top:0}
tr:hover{background:#f5f5f5}
tr:first-child td{background:#fff2e8;font-weight:bold}
tr:first-child td.orderNum{color:#ff4d4f}
td.orderNum{font-weight:bold}

/* è¡¨æ ¼åˆ—å®½è°ƒæ•´ */
#adminTable thead tr th:nth-child(1) { width: 10%; } /* ç¼–å· */
#adminTable thead tr th:nth-child(2) { width: 15%; } /* è®¢å•å· */
#adminTable thead tr th:nth-child(3) { width: 15%; } /* å¥—é¤ç±»å‹ */
#adminTable theach tr th:nth-child(4) { width: 15%; } /* æœ¬å•æ”¶ç›Š */
#adminTable thead tr th:nth-child(5) { width: 20%; } /* ä»Šæ—¥æ€»æ”¶ç›Š */
#adminTable thead tr th:nth-child(6) { width: 20%; } /* æ€»æ”¶ç›Š */

/*========== åŠ è½½å’Œé”™è¯¯çŠ¶æ€ ==========*/
.loading{text-align:center;padding:40px;font-size:16px;color:#666}
.loading::after{content:"";display:inline-block;width:20px;height:20px;border:3px solid #f3f3f3;border-top:3px solid #000;border-radius:50%;animation:spin 1s linear infinite;margin-left:10px}
.error{text-align:center;padding:40px;color:#ff4d4f;font-size:16px}
@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}

/*========== å“åº”å¼è®¾è®¡ ==========*/
@media (max-width: 768px){
    .control-panel{grid-template-columns:1fr 1fr}
    .stats{grid-template-columns:1fr 1fr}
    th,td{padding:8px 4px;font-size:12px}
    .header h1{font-size:20px}
}
@media (max-width: 480px){
    .control-panel{grid-template-columns:1fr}
    .stats{grid-template-columns:1fr}
}
</style>
</head>
<body>
<div class="header">
    <h1>ğŸ• æœºå™¨ç‹—ç®¡ç†ç³»ç»Ÿ</h1>
    <p>å®æ—¶ç›‘æ§è®¢å•å’Œæ”¶ç›Šæƒ…å†µ</p>
</div>

<div class="control-panel">
    <div class="control-btn refresh" onclick="loadData()">
        ğŸ”„ åˆ·æ–°æ•°æ®
    </div>
    <div class="control-btn" onclick="exportData()">
        ğŸ“Š å¯¼å‡ºæ•°æ®
    </div>
    <div class="control-btn clear" onclick="clearData()">
        ğŸ—‘ï¸ æ¸…é™¤æ•°æ®
    </div>
</div>

<div class="stats">
    <div class="stat-card">
        <h3>ä»Šæ—¥è®¢å•</h3>
        <div class="value" id="todayOrders">0</div>
    </div>
    <div class="stat-card">
        <h3>æ€»æ”¶ç›Š</h3>
        <div class="value" id="totalRevenue">0å…ƒ</div>
    </div>
    <div class="stat-card">
        <h3>ä»Šæ—¥æ”¶ç›Š</h3>
        <div class="value" id="dailyRevenue">0å…ƒ</div>
    </div>
</div>

<div class="table-container">
    <table id="adminTable">
        <thead>
            <tr>
                <th>ç¼–å·</th>
                <th>è®¢å•å·</th>
                <th>å¥—é¤ç±»å‹</th>
                <th>æœ¬å•æ”¶ç›Š</th>
                <th>ä»Šæ—¥æ€»æ”¶ç›Š</th>
                <th>æ€»æ”¶ç›Š</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<div id="adminSum" style="margin-top:20px;padding:15px;background:#fff;border-radius:8px;text-align:center;font-weight:bold;"></div>

<script>
// å…¨å±€å˜é‡
let currentData = null;

/*========== åŠ è½½æ•°æ® ==========*/
async function loadData() {
    const password = prompt('è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç :');
    if (password !== 'qwer123') {
        alert('å¯†ç é”™è¯¯');
        return;
    }

    try {
        const response = await fetch('/api/admin', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ password: password })
        });
        
        const data = await response.json();
        
        if (data.ok) {
            currentData = data;
            renderTable(data);
            updateStats(data);
        } else {
            alert('åŠ è½½å¤±è´¥: ' + data.msg);
        }
    } catch (error) {
        console.error('åŠ è½½æ•°æ®é”™è¯¯:', error);
        alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
    }
}

/*========== æ¸²æŸ“è¡¨æ ¼ ==========*/
function renderTable(data) {
    const tbody = document.querySelector('#adminTable tbody');
    tbody.innerHTML = '';
    
    data.rows.forEach((row, index) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${row.id}</td>
            <td class="orderNum">${row.orderNum.toString().padStart(4, '0')}</td>
            <td>å¥—é¤${row.planType}</td>
            <td>${row.price}å…ƒ</td>
            <td>${row.dailyTotal}å…ƒ</td>
            <td>${row.total}å…ƒ</td>
        `;
        tbody.appendChild(tr);
    });
}

/*========== æ›´æ–°ç»Ÿè®¡ä¿¡æ¯ ==========*/
function updateStats(data) {
    document.getElementById('todayOrders').textContent = data.rows.length;
    document.getElementById('totalRevenue').textContent = data.total + 'å…ƒ';
    document.getElementById('dailyRevenue').textContent = data.dailyTotal + 'å…ƒ';
    document.getElementById('adminSum').textContent = `æ€»æ”¶ç›Šï¼š${data.total}å…ƒ | ä»Šæ—¥æ”¶ç›Šï¼š${data.dailyTotal}å…ƒ`;
}

/*========== å¯¼å‡ºæ•°æ® ==========*/
function exportData() {
    if (!currentData) {
        alert('è¯·å…ˆåŠ è½½æ•°æ®');
        return;
    }
    
    const csvContent = [
        ['ç¼–å·', 'è®¢å•å·', 'å¥—é¤ç±»å‹', 'æœ¬å•æ”¶ç›Š', 'ä»Šæ—¥æ€»æ”¶ç›Š', 'æ€»æ”¶ç›Š'],
        ...currentData.rows.map(row => [
            row.id,
            row.orderNum.toString().padStart(4, '0'),
            'å¥—é¤' + row.planType,
            row.price + 'å…ƒ',
            row.dailyTotal + 'å…ƒ',
            row.total + 'å…ƒ'
        ])
    ].map(row => row.join(',')).join('\n');
    
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `æœºå™¨ç‹—è®¢å•æ•°æ®_${new Date().toLocaleDateString()}.csv`;
    link.click();
}

/*========== æ¸…é™¤æ•°æ® ==========*/
async function clearData() {
    const password = prompt('è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç ç¡®è®¤æ¸…é™¤:');
    if (password !== 'qwer123') {
        alert('å¯†ç é”™è¯¯');
        return;
    }
    
    if (!confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
        return;
    }
    
    try {
        const response = await fetch('/api/clear', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ password: password })
        });
        
        const data = await response.json();
        
        if (data.ok) {
            alert('æ•°æ®å·²æ¸…é™¤');
            loadData();
        } else {
            alert('æ¸…é™¤å¤±è´¥: ' + data.msg);
        }
    } catch (error) {
        console.error('æ¸…é™¤æ•°æ®é”™è¯¯:', error);
        alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
    }
}

// é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åŠ è½½æ•°æ®
document.addEventListener('DOMContentLoaded', function() {
    console.log('ç®¡ç†ç³»ç»Ÿå·²åŠ è½½');
    // å¯ä»¥å–æ¶ˆæ³¨é‡Šä¸‹ä¸€è¡Œæ¥è‡ªåŠ¨åŠ è½½æ•°æ®
    // loadData();
});
</script>
</body>
</html>
