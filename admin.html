<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>机器狗 - 管理系统</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body { display: flex; flex-direction: column; min-height: 100vh; background: #f7f7f7; font-family: -apple-system, "Helvetica Neue", Arial, sans-serif; padding: 20px; }
.header { text-align: center; margin-bottom: 20px; padding: 15px; background: #fff; border-radius: 10px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); }
.header h1 { margin: 0; color: #333; font-size: 24px; }
.control-panel { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-bottom: 20px; }
.control-btn { padding: 10px; background: #fff; border: 2px solid #000; border-radius: 8px; text-align: center; cursor: pointer; font-weight: bold; transition: all 0.3s; }
.control-btn:hover { background: #000; color: #fff; transform: translateY(-2px); }
.control-btn.refresh { background: #1890ff; color: #fff; border-color: #1890ff; }
.control-btn.clear { background: #ff4d4f; color: #fff; border-color: #ff4d4f; }
.stats { display: grid; grid-template-columns: repeat(auto-fit, minmax 150px, 1fr); gap: 15px; margin-bottom: 20px; }
.stat-card { padding: 15px; background: #fff; border-radius: 8px; text-align: center; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); }
.stat-card h3 { margin: 0 0 10px 0; font-size: 14px; color: #666; }
.stat-card .value { font-size: 24px; font-weight: bold; color: #000; }
.table-container { flex: 1; overflow: auto; background: #fff; border-radius: 8px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); }
table { width: 100%; border-collapse: collapse; }
th, td { border: 1px solid #e8e8e8; padding: 8px 4px; text-align: center; font-size: 13px; }
th { background: #fafafa; font-weight: bold; position: sticky; top: 0; }
tr:hover { background: #f5f5f5; }
.status-queue { color: #1890ff; }
.status-playing { color: #52c41a; font-weight: bold; }
.status-end { color: #999; }
.btn-op { margin: 2px; padding: 4px 6px; font-size: 12px; border: 1px solid #000; border-radius: 4px; background: #fff; cursor: pointer; }
.btn-op:hover { background: #000; color: #fff; }
@media (max-width: 768px) { th, td { font-size: 12px; padding: 6px 3px; } .btn-op { font-size: 11px; } }
</style>
</head>
<body>
<div class="header">
  <h1>🐕 机器狗管理系统</h1>
  <p>实时监控订单和收益情况</p>
</div>

<div class="control-panel">
  <div class="control-btn refresh" onclick="loadData()">🔄 刷新数据</div>
  <div class="control-btn" onclick="exportData()">📊 导出数据</div>
  <div class="control-btn clear" onclick="clearData()">🗑️ 清除数据</div>
</div>

<div class="stats">
  <div class="stat-card"><h3>今日订单</h3><div class="value" id="todayOrders">0</div></div>
  <div class="stat-card"><h3>总收益</h3><div class="value" id="totalRevenue">0元</div></div>
  <div class="stat-card"><h3>今日收益</h3><div class="value" id="dailyRevenue">0元</div></div>
</div>

<div class="table-container">
  <table id="adminTable">
    <thead>
      <tr>
        <th>编号</th><th>订单号</th><th>套餐</th><th>金额</th>
        <th>状态</th><th>剩余(秒)</th><th>操作</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
let currentData = null;
let remainTimer = null;

async function loadData() {
  const pwd = prompt('请输入管理员密码:');
  if (pwd !== 'qwer123') { alert('密码错误'); return; }

  try {
    const res = await fetch('/api/admin', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ password: pwd })
    });
    const json = await res.json();
    if (json.ok) {
      currentData = json;
      renderTable(json);
      updateStats(json);
      startRemainCountdown();
    } else {
      alert('加载失败: ' + json.msg);
    }
  } catch (e) {
    console.error(e);
    alert('网络错误');
  }
}

function renderTable(data) {
  const tbody = document.querySelector('#adminTable tbody');
  tbody.innerHTML = '';
  data.rows.forEach(r => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${r.id}</td>
      <td>${r.orderNum}</td>
      <td>套餐${r.planType}</td>
      <td>${r.price}元</td>
      <td class="status-${r.status}">${statusText(r.status)}</td>
      <td id="rm-${r.id}">${r.remaining}</td>
      <td>
        <button class="btn-op" onclick="orderOp(${r.id},'skip')">跳过</button>
        <button class="btn-op" onclick="orderOp(${r.id},'end')">终止</button>
        <button class="btn-op" onclick="orderOp(${r.id},'pause')">暂停</button>
        <button class="btn-op" onclick="orderOp(${r.id},'resume')">继续</button>
      </td>`;
    tbody.appendChild(tr);
  });
}

function statusText(s) {
  switch (s) {
    case 'queue': return '排队中';
    case 'playing': return '游玩中';
    case 'end': return '结束';
    default: return s;
  }
}

function updateStats(data) {
  document.getElementById('todayOrders').textContent = data.rows.length;
  document.getElementById('totalRevenue').textContent = data.total + '元';
  document.getElementById('dailyRevenue').textContent = data.dailyTotal + '元';
}

function startRemainCountdown() {
  if (remainTimer) clearInterval(remainTimer);
  remainTimer = setInterval(() => {
    document.querySelectorAll('td[id^="rm-"]').forEach(el => {
      let sec = parseInt(el.textContent);
      if (sec > 0) el.textContent = sec - 1;
    });
  }, 1000);
}

async function orderOp(id, action) {
  const res = await fetch('/api/orderOp', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ id, action })
  });
  const json = await res.json();
  if (json.ok) loadData(); else alert(json.msg);
}

async function exportData() {
  if (!currentData) { alert('请先加载数据'); return; }
  const rows = [
    ['订单号', '套餐', '金额', '状态', '剩余秒', '日期'],
    ...currentData.rows.map(r => [r.orderNum, r.planType, r.price, r.status, r.remaining, r.date])
  ].map(r => r.join(',')).join('\n');
  const blob = new Blob([rows], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = `机器狗订单_${new Date().toLocaleDateString()}.csv`;
  link.click();
}

async function clearData() {
  if (!confirm('确定清空所有数据？')) return;
  const pwd = prompt('请输入管理员密码确认:');
  if (pwd !== 'qwer123') { alert('密码错误'); return; }
  const res = await fetch('/api/clear', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ password: pwd })
  });
  const json = await res.json();
  alert(json.msg);
  if (json.ok) loadData();
}

// 自动首次加载
window.addEventListener('DOMContentLoaded', () => loadData());
</script>
</body>
</html>
