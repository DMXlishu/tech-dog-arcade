<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>æœºå™¨ç‹— - ç®¡ç†ç³»ç»Ÿ</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body { display: flex; flex-direction: column; min-height: 100vh; background: #f7f7f7; font-family: -apple-system, "Helvetica Neue", Arial, sans-serif; padding: 20px; }
.header { text-align: center; margin-bottom: 20px; padding: 15px; background: #fff; border-radius: 10px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); }
.header h1 { margin: 0; color: #333; font-size: 24px; }
.control-panel { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-bottom: 20px; }
.control-btn { padding: 10px; background: #fff; border: 2px solid #000; border-radius: 8px; text-align: center; cursor: pointer; font-weight: bold; transition: all 0.3s; }
.control-btn:hover { background: #000; color: #fff; transform: translateY(-2px); }
.control-btn.refresh { background: #1890ff; color: #fff; border-color: #1890ff; }
.control-btn.clear { background: #ff4d4f; color: #fff; border-color: #ff4d4f; }
.stats { display: grid; grid-template-columns: repeat(auto-fit, minmax 150px, 1fr); gap: 15px; margin-bottom: 20px; }
.stat-card { padding: 15px; background: #fff; border-radius: 8px; text-align: center; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); }
.stat-card h3 { margin: 0 0 10px 0; font-size: 14px; color: #666; }
.stat-card .value { font-size: 24px; font-weight: bold; color: #000; }
.table-container { flex: 1; overflow: auto; background: #fff; border-radius: 8px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); }
table { width: 100%; border-collapse: collapse; }
th, td { border: 1px solid #e8e8e8; padding: 8px 4px; text-align: center; font-size: 13px; }
th { background: #fafafa; font-weight: bold; position: sticky; top: 0; }
tr:hover { background: #f5f5f5; }
.status-queue { color: #1890ff; }
.status-playing { color: #52c41a; font-weight: bold; }
.status-end { color: #999; }
.btn-op { margin: 2px; padding: 4px 6px; font-size: 12px; border: 1px solid #000; border-radius: 4px; background: #fff; cursor: pointer; }
.btn-op:hover { background: #000; color: #fff; }
@media (max-width: 768px) { th, td { font-size: 12px; padding: 6px 3px; } .btn-op { font-size: 11px; } }
</style>
</head>
<body>
<div class="header">
  <h1>ğŸ• æœºå™¨ç‹—ç®¡ç†ç³»ç»Ÿ</h1>
  <p>å®æ—¶ç›‘æ§è®¢å•å’Œæ”¶ç›Šæƒ…å†µ</p>
</div>

<div class="control-panel">
  <div class="control-btn refresh" onclick="loadData()">ğŸ”„ åˆ·æ–°æ•°æ®</div>
  <div class="control-btn" onclick="exportData()">ğŸ“Š å¯¼å‡ºæ•°æ®</div>
  <div class="control-btn clear" onclick="clearData()">ğŸ—‘ï¸ æ¸…é™¤æ•°æ®</div>
</div>

<div class="stats">
  <div class="stat-card"><h3>ä»Šæ—¥è®¢å•</h3><div class="value" id="todayOrders">0</div></div>
  <div class="stat-card"><h3>æ€»æ”¶ç›Š</h3><div class="value" id="totalRevenue">0å…ƒ</div></div>
  <div class="stat-card"><h3>ä»Šæ—¥æ”¶ç›Š</h3><div class="value" id="dailyRevenue">0å…ƒ</div></div>
</div>

<div class="table-container">
  <table id="adminTable">
    <thead>
      <tr>
        <th>ç¼–å·</th><th>è®¢å•å·</th><th>å¥—é¤</th><th>é‡‘é¢</th>
        <th>çŠ¶æ€</th><th>å‰©ä½™(ç§’)</th><th>æ“ä½œ</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
let currentData = null;
let remainTimer = null;

async function loadData() {
  const pwd = prompt('è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç :');
  if (pwd !== 'qwer123') { alert('å¯†ç é”™è¯¯'); return; }

  try {
    const res = await fetch('/api/admin', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ password: pwd })
    });
    const json = await res.json();
    if (json.ok) {
      currentData = json;
      renderTable(json);
      updateStats(json);
      startRemainCountdown();
    } else {
      alert('åŠ è½½å¤±è´¥: ' + json.msg);
    }
  } catch (e) {
    console.error(e);
    alert('ç½‘ç»œé”™è¯¯');
  }
}

function renderTable(data) {
  const tbody = document.querySelector('#adminTable tbody');
  tbody.innerHTML = '';
  data.rows.forEach(r => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${r.id}</td>
      <td>${r.orderNum}</td>
      <td>å¥—é¤${r.planType}</td>
      <td>${r.price}å…ƒ</td>
      <td class="status-${r.status}">${statusText(r.status)}</td>
      <td id="rm-${r.id}">${r.remaining}</td>
      <td>
        <button class="btn-op" onclick="orderOp(${r.id},'skip')">è·³è¿‡</button>
        <button class="btn-op" onclick="orderOp(${r.id},'end')">ç»ˆæ­¢</button>
        <button class="btn-op" onclick="orderOp(${r.id},'pause')">æš‚åœ</button>
        <button class="btn-op" onclick="orderOp(${r.id},'resume')">ç»§ç»­</button>
      </td>`;
    tbody.appendChild(tr);
  });
}

function statusText(s) {
  switch (s) {
    case 'queue': return 'æ’é˜Ÿä¸­';
    case 'playing': return 'æ¸¸ç©ä¸­';
    case 'end': return 'ç»“æŸ';
    default: return s;
  }
}

function updateStats(data) {
  document.getElementById('todayOrders').textContent = data.rows.length;
  document.getElementById('totalRevenue').textContent = data.total + 'å…ƒ';
  document.getElementById('dailyRevenue').textContent = data.dailyTotal + 'å…ƒ';
}

function startRemainCountdown() {
  if (remainTimer) clearInterval(remainTimer);
  remainTimer = setInterval(() => {
    document.querySelectorAll('td[id^="rm-"]').forEach(el => {
      let sec = parseInt(el.textContent);
      if (sec > 0) el.textContent = sec - 1;
    });
  }, 1000);
}

async function orderOp(id, action) {
  const res = await fetch('/api/orderOp', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ id, action })
  });
  const json = await res.json();
  if (json.ok) loadData(); else alert(json.msg);
}

async function exportData() {
  if (!currentData) { alert('è¯·å…ˆåŠ è½½æ•°æ®'); return; }
  const rows = [
    ['è®¢å•å·', 'å¥—é¤', 'é‡‘é¢', 'çŠ¶æ€', 'å‰©ä½™ç§’', 'æ—¥æœŸ'],
    ...currentData.rows.map(r => [r.orderNum, r.planType, r.price, r.status, r.remaining, r.date])
  ].map(r => r.join(',')).join('\n');
  const blob = new Blob([rows], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = `æœºå™¨ç‹—è®¢å•_${new Date().toLocaleDateString()}.csv`;
  link.click();
}

async function clearData() {
  if (!confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰æ•°æ®ï¼Ÿ')) return;
  const pwd = prompt('è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç ç¡®è®¤:');
  if (pwd !== 'qwer123') { alert('å¯†ç é”™è¯¯'); return; }
  const res = await fetch('/api/clear', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ password: pwd })
  });
  const json = await res.json();
  alert(json.msg);
  if (json.ok) loadData();
}

// è‡ªåŠ¨é¦–æ¬¡åŠ è½½
window.addEventListener('DOMContentLoaded', () => loadData());
</script>
</body>
</html>
