<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>æœºå™¨ç‹—æ¸¸ä¹åœº - æ™ºèƒ½æ’é˜Ÿç³»ç»Ÿ</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
/*========== åŸºç¡€é‡ç½® ==========*/
*{box-sizing:border-box;margin:0;padding:0}
body{display:flex;flex-direction:column;min-height:100vh;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);font-family:-apple-system,"Helvetica Neue",Arial,sans-serif;color:#333;}

/*========== ä¸»å®¹å™¨ ==========*/
.container{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px;max-width:1200px;margin:0 auto;width:100%;}

/*========== æ ‡é¢˜æ ·å¼ ==========*/
.header{text-align:center;margin-bottom:30px;color:white;text-shadow:2px 2px 4px rgba(0,0,0,0.3);}
.header h1{font-size:2.5rem;margin-bottom:10px;font-weight:bold;}
.header p{font-size:1.2rem;opacity:0.9;}

/*========== è§†é¢‘å®¹å™¨ ==========*/
.video-container{width:100%;max-width:600px;margin:20px 0;background:rgba(255,255,255,0.95);border-radius:15px;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,0.2);text-align:center;}
.video-container video{width:100%;border-radius:10px;border:3px solid #fff;box-shadow:0 5px 15px rgba(0,0,0,0.1);}
.video-desc{margin-top:15px;color:#666;font-size:1rem;}

/*========== æ”¯ä»˜æŒ‰é’®åŒºåŸŸ ==========*/
.payment-section{width:100%;max-width:600px;background:rgba(255,255,255,0.95);border-radius:15px;padding:25px;box-shadow:0 10px 30px rgba(0,0,0,0.2);text-align:center;margin:20px 0;}
.payment-buttons{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin:20px 0;}
.pay-btn{padding:15px 25px;background:linear-gradient(45deg, #FFD700, #FFA500);border:none;border-radius:10px;font-size:1.1rem;font-weight:bold;color:#000;cursor:pointer;transition:all 0.3s ease;box-shadow:0 4px 15px rgba(255,165,0,0.3);border:2px solid #000;}
.pay-btn:hover{transform:translateY(-3px);box-shadow:0 6px 20px rgba(255,165,0,0.4);}
.pay-btn:active{transform:translateY(-1px);}

/*========== å®æ—¶ä¿¡æ¯æ  ==========*/
.live-info{position:fixed;bottom:160px;left:50%;transform:translateX(-50%);background:linear-gradient(45deg, #FFD700, #FFA500);border:3px solid #000;border-radius:15px;padding:15px 30px;text-align:center;font-size:1.1rem;font-weight:bold;color:#000;box-shadow:0 5px 20px rgba(0,0,0,0.3);z-index:100;min-width:300px;}

/*========== åº•éƒ¨å¯¼èˆªå’ŒæŒ‰é’® ==========*/
.tabbar{display:flex;height:60px;background:#fff;border-top:3px solid #000;position:fixed;bottom:0;left:0;right:0;z-index:1000;}
.tabbar .item{flex:1;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:1rem;font-weight:bold;color:#333;border-right:2px solid #000;transition:all 0.3s ease;}
.tabbar .item:last-child{border-right:none}
.tabbar .item.active{background:#000;color:#fff;}

.btn-fixed{position:fixed;bottom:80px;left:50%;transform:translateX(-50%);display:flex;gap:20px;pointer-events:none;z-index:900;}
.btn-fixed .btn{pointer-events:auto;width:150px;height:50px;line-height:50px;text-align:center;font-size:1.1rem;font-weight:bold;color:#000;background:linear-gradient(45deg, #FFD700, #FFA500);border:3px solid #000;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,0.2);cursor:pointer;transition:all 0.3s ease;}
.btn-fixed .btn:hover{transform:translateY(-3px);box-shadow:0 8px 25px rgba(0,0,0,0.3);}

/*========== å¼¹çª—æ ·å¼ ==========*/
.modal{position:fixed;inset:0;background:rgba(0,0,0,.8);display:none;align-items:center;justify-content:center;z-index:2000;backdrop-filter:blur(5px);}
.modal.active{display:flex;}
.modal-content{background:#fff;border-radius:20px;padding:30px;width:90%;max-width:400px;text-align:center;box-shadow:0 20px 40px rgba(0,0,0,0.3);border:3px solid #000;}
.modal-content h3{margin-bottom:20px;font-size:1.5rem;color:#000;}
.modal-content button{width:100%;margin:10px 0;padding:15px;font-size:1.1rem;border:2px solid #ccc;border-radius:10px;background:#fff;cursor:pointer;transition:all 0.3s ease;}
.modal-content button.primary{background:#000;color:#fff;border-color:#000;}
.modal-content button:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(0,0,0,0.1);}

/*========== é¡µé¢å†…å®¹ ==========*/
.page{display:none;width:100%;max-width:600px;margin:0 auto;background:rgba(255,255,255,0.95);border-radius:15px;padding:30px;box-shadow:0 10px 30px rgba(0,0,0,0.2);}
.page.active{display:block;}
#home{display:block;}

/*========== æˆ‘çš„é¡µé¢è°ƒè¯•æŒ‰é’® ==========*/
.debug-buttons{display:grid;grid-template-columns:1fr 1fr;gap:15px;margin:20px 0;}
.debug-btn{padding:12px;background:linear-gradient(45deg, #ff6b6b, #ee5a24);border:none;border-radius:8px;color:white;font-weight:bold;cursor:pointer;border:2px solid #000;}
.debug-btn:hover{transform:translateY(-2px);}

/*========== åŠ è½½åŠ¨ç”» ==========*/
.loading{display:inline-block;width:25px;height:25px;border:3px solid #f3f3f3;border-top:3px solid #000;border-radius:50%;animation:spin 1s linear infinite;margin:0 10px;}
@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}

/*========== å“åº”å¼è®¾è®¡ ==========*/
@media (max-width: 768px){
    .header h1{font-size:2rem;}
    .header p{font-size:1rem;}
    .payment-buttons{grid-template-columns:1fr;}
    .pay-btn{padding:12px 20px;font-size:1rem;}
    .btn-fixed .btn{width:130px;height:45px;line-height:45px;font-size:1rem;}
    .live-info{font-size:1rem;padding:12px 20px;min-width:250px;bottom:140px;}
    .debug-buttons{grid-template-columns:1fr;}
}
</style>
</head>
<body>
<!-- ä¸»å®¹å™¨ -->
<div class="container">
    <!-- é¦–é¡µ -->
    <div id="home" class="page active">
        <div class="header">
            <h1>ğŸ¤– æœºå™¨ç‹—æ™ºèƒ½æ¸¸ä¹åœº</h1>
            <p>æ‰«ç å–å· Â· æ™ºèƒ½æ’é˜Ÿ Â· ç•…å¿«ä½“éªŒ</p>
        </div>

        <!-- è§†é¢‘åŒºåŸŸ -->
        <div class="video-container">
            <video src="video1.mp4" controls poster="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 600 400'%3E%3Crect width='600' height='400' fill='%23f0f0f0'/%3E%3Cpath d='M240,200 L360,200 L300,150 Z' fill='%23ccc'/%3E%3C/svg%3E">
                æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾
            </video>
            <div class="video-desc">è§‚çœ‹æœºå™¨ç‹—ç²¾å½©è¡¨æ¼”å’Œæ“ä½œæ¼”ç¤º</div>
        </div>

        <!-- æ”¯ä»˜æµ‹è¯•åŒºåŸŸ -->
        <div class="payment-section">
            <h3>ğŸ¯ æµ‹è¯•æ”¯ä»˜åŠŸèƒ½</h3>
            <p>ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ¨¡æ‹Ÿæ”¯ä»˜æˆåŠŸï¼Œæµ‹è¯•æœåŠ¡å™¨å“åº”</p>
            <div class="payment-buttons">
                <button class="pay-btn" onclick="simulatePay(1)">
                    ğŸ’° 10å…ƒ / 30åˆ†é’Ÿ
                </button>
                <button class="pay-btn" onclick="simulatePay(2)">
                    ğŸ’° 5å…ƒ / 10åˆ†é’Ÿ
                </button>
            </div>
        </div>
    </div>

    <!-- æˆ‘çš„é¡µé¢ -->
    <div id="my" class="page">
        <h2>ğŸ‘¤ æˆ‘çš„è´¦æˆ·</h2>
        <p>è®¢å•è®°å½•å’Œä¸ªäººä¿¡æ¯ç®¡ç†</p>
        
        <div class="debug-buttons">
            <button class="debug-btn" onclick="simulatePay(1)">
                ğŸ§ª æµ‹è¯•å¥—é¤1 (10å…ƒ)
            </button>
            <button class="debug-btn" onclick="simulatePay(2)">
                ğŸ§ª æµ‹è¯•å¥—é¤2 (5å…ƒ)
            </button>
        </div>
        
        <div style="margin-top:30px;text-align:center;">
            <p>æ›´å¤šåŠŸèƒ½å¼€å‘ä¸­...</p>
        </div>
    </div>

    <!-- ç”¨æˆ·åè®®é¡µé¢ -->
    <div id="agreement" class="page">
        <h2>ğŸ“ ç”¨æˆ·åè®®</h2>
        <p>æœºå™¨ç‹—æ¸¸ç©é¡»çŸ¥å’Œå…è´£æ¡æ¬¾</p>
        
        <div style="margin-top:20px;">
            <h3>å®‰å…¨é¡»çŸ¥</h3>
            <p>1. è¯·å‹¿è§¦æ‘¸æœºå™¨ç‹—çš„è¿åŠ¨éƒ¨ä»¶</p>
            <p>2. å„¿ç«¥éœ€åœ¨æˆäººé™ªåŒä¸‹ä½¿ç”¨</p>
            <p>3. éµå®ˆç°åœºå·¥ä½œäººå‘˜æŒ‡ç¤º</p>
            
            <h3>å…è´£å£°æ˜</h3>
            <p>å› ä¸å½“æ“ä½œé€ æˆçš„æŸåéœ€ç…§ä»·èµ”å¿</p>
        </div>
    </div>
</div>

<!-- å®æ—¶æ’é˜Ÿä¿¡æ¯ -->
<div class="live-info" id="liveInfo">
    ğŸ“ å½“å‰ç¼–å·ï¼š---- | æ’é˜Ÿï¼š--äºº | é¢„è®¡ï¼š--:--
</div>

<!-- åº•éƒ¨æŒ‰é’® -->
<div class="btn-fixed">
    <div class="btn" id="btnWantPlay">ğŸ® æˆ‘è¦ç©</div>
    <div class="btn">ğŸ† æˆ‘è¦æŒ‘æˆ˜</div>
</div>

<!-- åº•éƒ¨å¯¼èˆª -->
<nav class="tabbar">
    <div class="item" data-page="my">ğŸ‘¤ æˆ‘çš„</div>
    <div class="item active" data-page="home">ğŸ  é¦–é¡µ</div>
    <div class="item" data-page="agreement">ğŸ“ åè®®</div>
</nav>

<!-- é€‰æ‹©æ“ä½œå¼¹çª— -->
<div class="modal" id="modalFirst">
    <div class="modal-content">
        <h3>ğŸ® é€‰æ‹©æ“ä½œ</h3>
        <button id="watchVideoBtn" class="primary">ğŸ“º è§‚çœ‹æ•™å­¦è§†é¢‘</button>
        <button id="directPlayBtn">ğŸ¯ ç›´æ¥å¼€å§‹ç©</button>
        <button onclick="closeModal('modalFirst')">å–æ¶ˆ</button>
    </div>
</div>

<!-- æ”¯ä»˜æ–¹å¼å¼¹çª— -->
<div class="modal" id="modalPay">
    <div class="modal-content">
        <h3>ğŸ’³ é€‰æ‹©æ”¯ä»˜æ–¹å¼</h3>
        <button onclick="redirectToPay('wechat')">ğŸ’š å¾®ä¿¡æ”¯ä»˜</button>
        <button onclick="redirectToPay('alipay')">ğŸ’™ æ”¯ä»˜å®</button>
        <button onclick="redirectToPay('bank')">ğŸ’³ é“¶è¡Œå¡</button>
        <button onclick="closeModal('modalPay')">è¿”å›</button>
    </div>
</div>

<!-- æ’é˜Ÿä¸­å¼¹çª— -->
<div class="modal" id="modalQueue">
    <div class="modal-content">
        <h3>â³ æ’é˜Ÿä¸­</h3>
        <div style="font-size:2rem;margin:15px 0;">ğŸ¯</div>
        <p>æ‚¨çš„ç¼–å·ï¼š<strong id="queueNum">----</strong></p>
        <p>å‰é¢è¿˜æœ‰ <strong id="queueAhead">--</strong> äºº</p>
        <p>é¢„è®¡ç­‰å¾…ï¼š<strong id="queueTime">--:--</strong></p>
        <div class="loading" id="queueLoading" style="margin:15px auto;display:none;"></div>
        <button onclick="closeModal('modalQueue')" class="primary">ğŸ‘Œ çŸ¥é“äº†</button>
    </div>
</div>

<script>
// å…¨å±€å˜é‡
let refreshInterval = null;
let currentPrice = 0;
let currentTime = 0;

/*========== é¡µé¢åˆ‡æ¢ ==========*/
document.querySelectorAll('.tabbar .item').forEach(btn => {
    btn.addEventListener('click', function(){
        document.querySelectorAll('.tabbar .item').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        
        document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
        const pageId = this.dataset.page;
        document.getElementById(pageId).classList.add('active');
    });
});

/*========== å¼¹çª—æ§åˆ¶ ==========*/
function openModal(id){ 
    closeAllModal(); 
    document.getElementById(id).classList.add('active'); 
}
function closeModal(id){ 
    document.getElementById(id).classList.remove('active'); 
    if (id === 'modalQueue' && refreshInterval) {
        clearInterval(refreshInterval);
        refreshInterval = null;
    }
}
function closeAllModal(){ 
    document.querySelectorAll('.modal').forEach(m => m.classList.remove('active')); 
    if (refreshInterval) {
        clearInterval(refreshInterval);
        refreshInterval = null;
    }
}

/*========== æˆ‘è¦ç©æŒ‰é’® ==========*/
document.getElementById('btnWantPlay').addEventListener('click', function() {
    openModal('modalFirst');
});

// è§‚çœ‹è§†é¢‘æŒ‰é’®
document.getElementById('watchVideoBtn').addEventListener('click', function() {
    closeModal('modalFirst');
    alert('ğŸ“º æ•™å­¦è§†é¢‘åŠŸèƒ½å¼€å‘ä¸­...');
});

// ç›´æ¥ç©æŒ‰é’®
document.getElementById('directPlayBtn').addEventListener('click', function() {
    closeModal('modalFirst');
    openModal('modalPay');
});

/*========== æ”¯ä»˜è·³è½¬ ==========*/
function redirectToPay(channel) {
    const payUrls = {
        wechat: 'è¯·è¾“å…¥å¾®ä¿¡æ”¯ä»˜é“¾æ¥',
        alipay: 'è¯·è¾“å…¥æ”¯ä»˜å®æ”¯ä»˜é“¾æ¥', 
        bank: 'è¯·è¾“å…¥é“¶è¡Œå¡æ”¯ä»˜é“¾æ¥'
    };
    
    if (payUrls[channel].includes('è¯·è¾“å…¥')) {
        alert('âš ï¸ è¯·å…ˆé…ç½®æ”¯ä»˜é“¾æ¥');
        return;
    }
    
    // æ¨¡æ‹Ÿæ”¯ä»˜æˆåŠŸ
    closeModal('modalPay');
    simulatePay(1); // é»˜è®¤é€‰æ‹©å¥—é¤1
}

/*========== æ¨¡æ‹Ÿæ”¯ä»˜å‡½æ•° ==========*/
async function simulatePay(type){
    const price = type === 1 ? 10 : 5;
    const time = type === 1 ? 30 : 10;
    
    currentPrice = price;
    currentTime = time;
    
    console.log(`æ¨¡æ‹Ÿæ”¯ä»˜ï¼š${price}å…ƒ/${time}åˆ†é’Ÿ`);
    
    // æ˜¾ç¤ºæ’é˜Ÿå¼¹çª—
    openModal('modalQueue');
    document.getElementById('queueLoading').style.display = 'block';
    
    try {
        // æ¨¡æ‹Ÿç½‘ç»œè¯·æ±‚å»¶è¿Ÿ
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        // è°ƒç”¨åˆ›å»ºè®¢å•API
        const response = await fetch('/api/createOrder', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                price: price,
                time: time
            })
        });
        
        const data = await response.json();
        
        if(data.ok){
            updateQueueInfo(data);
            startQueuePolling(data.id);
        } else {
            throw new Error(data.msg || 'æ”¯ä»˜å¤±è´¥');
        }
        
    } catch (error) {
        console.error('æ”¯ä»˜é”™è¯¯:', error);
        alert('âŒ ' + error.message);
        closeModal('modalQueue');
    } finally {
        document.getElementById('queueLoading').style.display = 'none';
    }
}

/*========== æ›´æ–°æ’é˜Ÿä¿¡æ¯ ==========*/
function updateQueueInfo(data){
    document.getElementById('queueNum').textContent = data.orderNum || '0001';
    document.getElementById('queueAhead').textContent = data.ahead || '0';
    document.getElementById('queueTime').textContent = data.waitTime || 'ç«‹å³';
    
    // æ›´æ–°åº•éƒ¨å®æ—¶ä¿¡æ¯
    const liveInfo = document.getElementById('liveInfo');
    liveInfo.innerHTML = `ğŸ“ å½“å‰ç¼–å·ï¼š${data.orderNum || '0001'} | æ’é˜Ÿï¼š${data.ahead || '0'}äºº | é¢„è®¡ï¼š${data.waitTime || 'ç«‹å³'}`;
}

/*========== æ’é˜ŸçŠ¶æ€è½®è¯¢ ==========*/
function startQueuePolling(orderId){
    if (refreshInterval) clearInterval(refreshInterval);
    
    refreshInterval = setInterval(async () => {
        try {
            const response = await fetch(`/api/queueInfo?id=${orderId}`);
            const data = await response.json();
            
            if(data.ok){
                updateQueueInfo(data);
                
                // å¦‚æœæ’é˜Ÿå®Œæˆï¼Œåœæ­¢è½®è¯¢
                if(data.ahead === 0 || data.status === 'playing'){
                    clearInterval(refreshInterval);
                    refreshInterval = null;
                    alert('ğŸ‰ è½®åˆ°æ‚¨ç©äº†ï¼è¯·å‰å¾€æœºå™¨ç‹—å¤„');
                }
            }
        } catch (error) {
            console.error('è½®è¯¢é”™è¯¯:', error);
        }
    }, 5000);
}

// åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸ¤– æœºå™¨ç‹—æ’é˜Ÿç³»ç»Ÿå·²å¯åŠ¨');
});
</script>
</body>
</html>
